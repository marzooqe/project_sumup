
--Average time for a store to perform its first 5 transactions

WITH BASE_DATA AS (
    SELECT
        TP.STORE_ID,
        TP.STORE_NAME,
        TP.CREATED_AT,
        LEAD(TP.CREATED_AT) OVER (PARTITION BY TP.STORE_ID ORDER BY TP.CREATED_AT) AS NEXT_ORDER_DATE,
        RANK() OVER (PARTITION BY TP.STORE_ID ORDER BY TP.CREATED_AT) AS RANK
    FROM SUMUP."REPORTING".TRANSACTION_PERFORMANCE AS TP
    ORDER BY RANK
)

SELECT
    STORE_ID,
    STORE_NAME,
    AVG(NEXT_ORDER_DATE - CREATED_AT) AS AVG_TIME_TO_FIRST_FIVE_ORDER
FROM BASE_DATA
WHERE RANK <= 5
GROUP BY
    STORE_ID,
    STORE_NAME
ORDER BY
    AVG_TIME_TO_FIRST_FIVE_ORDER